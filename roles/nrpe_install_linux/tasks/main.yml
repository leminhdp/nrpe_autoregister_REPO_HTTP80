---
- include: "mount_iso.yml"
- name: Create Dirs on remote machine.
  file:
   path: "{{ item }}"
   state: directory
   mode: 0755
  with_items:
   - "{{ redis_rpmdir }}"
   - "{{ perldir }}"
   - "{{ rpmdir }}"
   - "{{ includedir }}"
   - "{{ softdir_dest }}"
- name: Copy file rpm for install PERL to remote machine.
  copy:
    src: "files/perl/{{ item }}"
    dest: "{{ perldir }}"
    owner: root
    group: root
    mode: 0755
  with_items: "{{ perl_rpm_package }}"
- name: "Check if packages is installed"
  package_facts:
    manager: "auto"
#- name: Packages Found in list result
#  debug:
#    msg: "package {{ item }} found"
#  when: "'{{ item }}' in ansible_facts.packages"
#  with_items: "{{ perl_package }}"
- name: Package Not Found in list result
  debug:
     msg: "package {{ item }} NOT found"
  when: "'{{ item }}' not in ansible_facts.packages"
  with_items: "{{ perl_package }}"
  register: check_perl
- name: Install Perl
  shell: cd "{{ perldir }}";yum install *.rpm -y
  when: "'perl' not in ansible_facts.packages"
- name: Update repositories cache and install packages
  yum:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items:
     - "autoconf"
     - "automake"
     - "gcc"
     - "openssl-devel"
- name : Copy file config to remote machine.
  copy:
   src: "files/{{ item }}"
   dest: "{{ includedir }}"
   owner: root
   group: root
   mode: 0775
  with_items:
   - "vnpay.cfg"
   - "vnpay_linux.cfg"
- name: Unpack NRPE source files
  unarchive:
    src: files/nrpe.tar.gz
    dest: "{{ softdir_dest }}"
- name: Configure NRPE
  shell: cd "{{ softdir_dest }}/{{ nrpesrc }}";./configure --enable-command-args
- name: Make All  NRPE
  shell: cd "{{ softdir_dest }}/{{ nrpesrc }}";make all;make install-groups-users;make install;make install-config;make install-init
- name: edit /etc/service
  shell: cd "{{ softdir_dest }}/{{ nrpesrc }}";sh -c "echo >> /etc/services";sh -c "sudo echo '# Nagios services' >> /etc/services";sh -c "sudo echo 'nrpe    5666/tcp' >> /etc/services"
- name: Edit /etc/sudoers
  command: sh -c "{{ context }}"
  notify:
  - restart nrpe
- name: Unpack NRPE Plugin source files
  unarchive:
    src: files/nagios-plugins-2.2.1.tar.gz
    dest: "{{ softdir_dest }}"
- name: Configure NRPE Plugin
  shell: cd "{{ softdir_dest }}/{{ nrpe_plugin_src }}";./configure;make;make install
  notify:
  - restart nrpe
- name: Unpack HariSakhon
  unarchive:
    src: files/lib.tar.gz
    dest: "{{ plugindir }}"
    owner: root
    group: root
    mode: 0755
- name : Copy file to remote machine.
  copy:
   src: "files/{{ item }}"
   dest: "{{ plugindir }}"
   owner: root
   group: root
   mode: 0775
  with_items:
   - "check_linux_stats.pl"
   - "check_time_diff.sh"
   - "count_connection_port.sh"
   - "check_web_log.pl"
   - "check_appVTB_log.pl"
- template:
   src: templates/nrpe.cfg.j2
   dest: /usr/local/nagios/etc/nrpe.cfg
   owner: nagios
   group: nagios
   mode: 0644
  notify: 
  - restart nrpe
#Ensure NRPE server is running and will start at boot
- name: Ensure NRPE server is running
  service:
    name: nrpe
    state: started
    enabled: yes
